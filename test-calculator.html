<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Unit Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .test-suite {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-case {
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 4px solid #ddd;
        }
        .test-case.pass {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .test-case.fail {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .test-label {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .test-details {
            font-size: 0.9em;
            color: #666;
            font-family: 'Courier New', monospace;
        }
        .summary {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        .summary h2 {
            margin: 0 0 10px 0;
        }
        .summary .stats {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>üß™ Real Estate Calculator Unit Tests</h1>
    <div id="summary" class="summary"></div>
    <div id="results"></div>

    <script src="calculator.js"></script>
    <script>
        // Excel Test Data (from Real Estate Valuation (4).xlsx)
        const EXCEL_INPUTS = {
            propertySize: 1189,
            totalValue: 1560000,
            downPaymentPercent: 20,
            registrationFeePercent: 4,  // Land registration fee
            tenure: 25,
            discountRate: 4,
            rentalROI: 6,
            serviceChargesPerSqFt: 10,
            exitValue: 1664600  // 1189 sq ft √ó 1400 per sq ft
        };

        const EXCEL_EXPECTED = {
            pricePerSqFt: 1312.026913,
            downPaymentAmt: 312000,
            landDeptFee: 62400,
            agentFee: 31200,
            annualRental: 93600,
            annualServiceCharges: 11890,
            netOperatingIncome: 81710,
            investedCapital: 405600,
            financingAmount: 1248000,
            monthlyEMI: 6587.403767,
            loanAmountAnnualized: 79048.8452,
            netAnnualCashFlow: 2661.154797,
            terminalValuePV: 624419.429,
            dcf: 660585.3912,
            npv: 254985.3912,
            dscr: 1.033664689,
            irr: 0.02596572182,
            roic: 0.5394956337
        };

        // Test runner
        function runTests() {
            const results = RealEstateCalculator.calculateInvestment(EXCEL_INPUTS);
            const testResults = [];
            let passed = 0;
            let failed = 0;

            // Helper function to compare values with tolerance
            function assertClose(actual, expected, tolerance = 0.01) {
                const diff = Math.abs(actual - expected);
                const percentDiff = expected !== 0 ? (diff / Math.abs(expected)) * 100 : diff;
                return percentDiff <= tolerance;
            }

            // Test each field
            const tests = [
                { name: 'Price per Sq Ft', key: 'pricePerSqFt' },
                { name: 'Down Payment Amount', key: 'downPaymentAmt' },
                { name: 'Dubai Land Department: 4%', key: 'landDeptFee' },
                { name: 'Agent Commission: 2%', key: 'agentFee' },
                { name: 'Rental Amount (Annualized)', key: 'annualRental' },
                { name: 'Service Charges (Annualized)', key: 'annualServiceCharges' },
                { name: 'Net Operating Profit (Annualized)', key: 'netOperatingIncome' },
                { name: 'Invested Capital', key: 'investedCapital' },
                { name: 'Financing Amount', key: 'financingAmount' },
                { name: 'EMI', key: 'monthlyEMI' },
                { name: 'Loan Amount (Annualized)', key: 'loanAmountAnnualized' },
                { name: 'Net Cash Flow (Annualized)', key: 'netAnnualCashFlow' },
                { name: 'Terminal Value (PV)', key: 'terminalValuePV' },
                { name: 'DCF', key: 'dcf' },
                { name: 'NPV', key: 'npv' },
                { name: 'DSCR', key: 'dscr' },
                { name: 'IRR', key: 'irr' },
                { name: 'ROIC', key: 'roic' }
            ];

            tests.forEach(test => {
                const actual = results[test.key];
                const expected = EXCEL_EXPECTED[test.key];
                const pass = assertClose(actual, expected, 0.01); // 0.01% tolerance

                if (pass) {
                    passed++;
                } else {
                    failed++;
                }

                testResults.push({
                    name: test.name,
                    key: test.key,
                    pass: pass,
                    actual: actual,
                    expected: expected,
                    diff: actual - expected,
                    percentDiff: expected !== 0 ? ((actual - expected) / expected * 100) : 0
                });
            });

            // Display results
            displayResults(testResults, passed, failed);
        }

        function displayResults(tests, passed, failed) {
            // Summary
            const total = passed + failed;
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `
                <h2>${passed === total ? '‚úÖ All Tests Passed!' : '‚ö†Ô∏è Some Tests Failed'}</h2>
                <div class="stats">
                    <strong>${passed}</strong> passed,
                    <strong>${failed}</strong> failed,
                    <strong>${total}</strong> total
                </div>
            `;

            // Detailed results
            const resultsDiv = document.getElementById('results');
            const suiteDiv = document.createElement('div');
            suiteDiv.className = 'test-suite';
            suiteDiv.innerHTML = '<h3>Test Results</h3>';

            tests.forEach(test => {
                const testDiv = document.createElement('div');
                testDiv.className = `test-case ${test.pass ? 'pass' : 'fail'}`;

                const icon = test.pass ? '‚úÖ' : '‚ùå';
                const status = test.pass ? 'PASS' : 'FAIL';

                testDiv.innerHTML = `
                    <div class="test-label">${icon} ${test.name} - ${status}</div>
                    <div class="test-details">
                        Expected: ${test.expected.toFixed(6)}<br>
                        Actual:   ${test.actual.toFixed(6)}<br>
                        Diff:     ${test.diff.toFixed(6)} (${test.percentDiff.toFixed(4)}%)
                    </div>
                `;

                suiteDiv.appendChild(testDiv);
            });

            resultsDiv.appendChild(suiteDiv);
        }

        // Run tests on page load
        runTests();
    </script>
</body>
</html>
