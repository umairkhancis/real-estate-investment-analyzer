<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Calculator - Dubai</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group .unit {
            color: #888;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .metric-card.highlight {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-left-color: #ff6b6b;
        }

        .metric-card.success {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border-left-color: #51cf66;
        }

        .metric-label {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .metric-subtext {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .interpretation {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .interpretation h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-badge.success {
            background: #51cf66;
            color: white;
        }

        .status-badge.warning {
            background: #ffd43b;
            color: #333;
        }

        .status-badge.danger {
            background: #ff6b6b;
            color: white;
        }

        .criteria-list {
            list-style: none;
            margin-top: 15px;
        }

        .criteria-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .criteria-list .icon {
            font-size: 1.3em;
        }

        .breakdown-section {
            margin-top: 25px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .breakdown-item.total {
            background: #667eea;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .cash-flow-viz {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .cash-flow-bars {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            padding: 20px 10px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .cash-flow-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .arrow-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 60px;
            justify-content: center;
        }

        .arrow {
            font-size: 2em;
            transition: all 0.3s;
            cursor: pointer;
        }

        .arrow.up {
            color: #51cf66;
        }

        .arrow.down {
            color: #ff6b6b;
        }

        .arrow:hover {
            transform: scale(1.2);
        }

        .year-label {
            font-size: 0.75em;
            color: #666;
            font-weight: 600;
        }

        .amount-label {
            font-size: 0.7em;
            color: #888;
            text-align: center;
        }

        .risk-factors {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .risk-factors h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .risk-factors ul {
            color: #856404;
            padding-left: 20px;
        }

        .risk-factors li {
            margin-bottom: 5px;
        }

        .educational-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .educational-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .educational-section h3 {
            color: #333;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .educational-section h4 {
            color: #555;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .educational-section p {
            line-height: 1.7;
            color: #444;
            margin-bottom: 15px;
        }

        .concept-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .concept-box.important {
            background: #fff9db;
            border-left-color: #ffc107;
        }

        .concept-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .formula-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
        }

        .formula-box code {
            color: #68d391;
        }

        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding-left: 0;
        }

        .step-list li {
            counter-increment: step-counter;
            margin-bottom: 20px;
            padding-left: 50px;
            position: relative;
        }

        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Real Estate Investment Analyzer</h1>
            <p>Discounted Cash Flow (DCF) Model for Property Investment Feasibility</p>
            <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.85;">
                For investors using developer payment plans & mortgage financing
            </p>
        </div>

        <!-- Educational Section -->
        <div class="educational-section">
            <button class="toggle-btn" onclick="toggleEducation()">
                üìö Learn How This Calculator Works (Click to Expand)
            </button>

            <div id="educationalContent" class="hidden">
                <h2>Understanding Real Estate Investment Valuation</h2>

                <p>Whether you're buying property with a developer payment plan or financing through a bank mortgage, understanding the <strong>true value</strong> of your investment is crucial. This calculator uses the <strong>Discounted Cash Flow (DCF)</strong> method‚Äîthe same approach professional investors and financial institutions use to value income-generating assets.</p>

                <h3>üí° The Core Concept: Time Value of Money</h3>

                <div class="concept-box important">
                    <h4>Why $100 Today ‚â† $100 Tomorrow</h4>
                    <p><strong>The fundamental principle:</strong> Money available today is worth more than the same amount in the future because of its earning potential.</p>

                    <p><strong>Example:</strong> If you have $100 today and can invest it at 4% annual return:</p>
                    <ul>
                        <li>Year 1: $100 √ó 1.04 = $104</li>
                        <li>Year 5: $100 √ó (1.04)‚Åµ = $121.67</li>
                        <li>Year 25: $100 √ó (1.04)¬≤‚Åµ = $266.58</li>
                    </ul>

                    <p><strong>Reverse logic:</strong> If someone promises you $266.58 in 25 years, its value TODAY (present value) is only $100 (assuming 4% discount rate).</p>
                </div>

                <h3>üèóÔ∏è Your Real Estate Investment Structure</h3>

                <p>When you invest in real estate with a payment plan or mortgage, here's what happens:</p>

                <ol class="step-list">
                    <li>
                        <strong>Initial Investment (Year 0)</strong><br>
                        You pay upfront costs: Down payment + Registration fees + Agent commission<br>
                        <em>This is your immediate cash outflow.</em>
                    </li>

                    <li>
                        <strong>Monthly Mortgage Payments (Years 1-25)</strong><br>
                        You pay the bank monthly EMI (Equated Monthly Installment)<br>
                        <em>Formula: EMI = [P √ó r √ó (1+r)‚Åø] / [(1+r)‚Åø - 1]</em><br>
                        Where P=loan amount, r=monthly rate, n=number of months
                    </li>

                    <li>
                        <strong>Rental Income (Years 1-25)</strong><br>
                        Property generates monthly/annual rental income<br>
                        <em>This is your recurring cash inflow.</em>
                    </li>

                    <li>
                        <strong>Operating Expenses (Years 1-25)</strong><br>
                        Service charges, maintenance, property management fees<br>
                        <em>These reduce your net rental income.</em>
                    </li>

                    <li>
                        <strong>Exit/Sale (Year 25)</strong><br>
                        You sell the property at market value (Terminal Value)<br>
                        <em>This is your final, large cash inflow.</em>
                    </li>
                </ol>

                <h3>üìä How This Calculator Values Your Investment</h3>

                <h4>1Ô∏è‚É£ Net Cash Flow (Annual)</h4>
                <div class="formula-box">
                    Net Cash Flow = Rental Income - Service Charges - EMI Payments
                </div>
                <p><strong>What it means:</strong> Your actual profit (or loss) each year after paying all expenses and mortgage.</p>

                <h4>2Ô∏è‚É£ Terminal Value (Property Exit Value)</h4>
                <div class="formula-box">
                    Future Value = Property Size √ó Expected Price per sq ft<br>
                    <code>Present Value = Future Value / (1 + discount rate)^years</code>
                </div>
                <p><strong>What it means:</strong> What the property sale proceeds are worth in TODAY's money. If you expect to sell for 1.66M in 25 years at 4% discount rate, its present value is only 624K today.</p>

                <div class="concept-box">
                    <p><strong>Why discount it?</strong> Because 1.66M received 25 years from now is not the same as having 1.66M today. Time erodes value due to:</p>
                    <ul>
                        <li>Inflation reducing purchasing power</li>
                        <li>Opportunity cost (could invest elsewhere)</li>
                        <li>Risk and uncertainty over long periods</li>
                    </ul>
                </div>

                <h4>3Ô∏è‚É£ Discounted Cash Flow (DCF)</h4>
                <div class="formula-box">
                    DCF = Œ£ [Cash Flow Year n / (1 + rate)‚Åø] + Terminal Value PV
                </div>
                <p><strong>What it means:</strong> The present value of ALL future cash you'll receive from this investment. It converts 25 years of future cash flows into a single number representing what they're worth TODAY.</p>

                <h4>4Ô∏è‚É£ Net Present Value (NPV)</h4>
                <div class="formula-box">
                    NPV = DCF - Initial Investment
                </div>
                <div class="concept-box success">
                    <p><strong>Decision Rule:</strong></p>
                    <ul>
                        <li><strong>NPV > 0:</strong> ‚úÖ Investment creates value‚Äîproceed!</li>
                        <li><strong>NPV = 0:</strong> ‚ö†Ô∏è Break-even‚Äîno value created or destroyed</li>
                        <li><strong>NPV < 0:</strong> ‚ùå Investment destroys value‚Äîavoid!</li>
                    </ul>
                </div>

                <h4>5Ô∏è‚É£ Internal Rate of Return (IRR)</h4>
                <div class="formula-box">
                    IRR = The rate that makes NPV = 0
                </div>
                <p><strong>What it means:</strong> Your actual annual return percentage on this investment. Compare it to your required return (hurdle rate):</p>
                <ul>
                    <li>If IRR > Hurdle Rate ‚Üí Good investment</li>
                    <li>If IRR < Hurdle Rate ‚Üí Look for better options</li>
                </ul>

                <h4>6Ô∏è‚É£ Return on Invested Capital (ROIC)</h4>
                <div class="formula-box">
                    ROIC = (Terminal Value PV - Initial Investment) / Initial Investment
                </div>
                <p><strong>What it means:</strong> Your total return as a percentage of your initial cash outlay. A 53.95% ROIC means you get back 1.54√ó your initial investment (in present value terms).</p>

                <h3>üéØ How to Use This Calculator</h3>

                <ol class="step-list">
                    <li>
                        <strong>Enter Property Details</strong><br>
                        Size and purchase price‚Äîthese are fixed by the developer/seller.
                    </li>

                    <li>
                        <strong>Enter Financing Terms</strong><br>
                        Down payment %, loan tenure, and interest rate from your bank.
                    </li>

                    <li>
                        <strong>Enter Operating Assumptions</strong><br>
                        Expected rental yield and service charges‚Äîresearch market rates.
                    </li>

                    <li>
                        <strong>Set Your Hurdle Rate</strong><br>
                        Your minimum acceptable return (discount rate). Use 4-8% typically.
                    </li>

                    <li>
                        <strong>Estimate Exit Value</strong><br>
                        Conservative estimate of price per sq ft at exit. Use current market rates or add 2-3% annual appreciation.
                    </li>

                    <li>
                        <strong>Review Results</strong><br>
                        Check NPV, IRR, and ROIC. Compare with your investment criteria.
                    </li>
                </ol>

                <div class="concept-box important">
                    <h4>‚ö†Ô∏è Important Notes</h4>
                    <ul>
                        <li><strong>Currency Agnostic:</strong> This calculator works with any currency (USD, AED, EUR, etc.)</li>
                        <li><strong>Conservative Estimates:</strong> Use realistic, not optimistic, assumptions</li>
                        <li><strong>Sensitivity Analysis:</strong> Test different scenarios (rental rates, exit values)</li>
                        <li><strong>Market Research:</strong> Validate assumptions with local market data</li>
                        <li><strong>Professional Advice:</strong> Consult with financial advisors for large investments</li>
                    </ul>
                </div>

                <h3>üìà Making Informed Decisions</h3>

                <p>This DCF model gives you the <strong>intrinsic value</strong> of the investment‚Äîwhat it's truly worth based on cash flows, not emotions or speculation. Use it to:</p>

                <ul>
                    <li>‚úÖ Compare multiple properties objectively</li>
                    <li>‚úÖ Negotiate better terms with developers</li>
                    <li>‚úÖ Understand if developer payment plans make financial sense</li>
                    <li>‚úÖ Determine optimal down payment and loan structure</li>
                    <li>‚úÖ Set realistic expectations for returns</li>
                    <li>‚úÖ Make data-driven investment decisions</li>
                </ul>

                <div class="concept-box success">
                    <h4>üíé Key Takeaway</h4>
                    <p><strong>Real estate investing is not just about buying property‚Äîit's about buying cash flows.</strong> This calculator helps you see beyond the property's price tag to understand its true economic value based on the money it will generate over time, adjusted for the time value of money.</p>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Input Section -->
            <div class="card">
                <h2>Investment Parameters</h2>

                <div class="input-group">
                    <label for="size">Property Size</label>
                    <input type="number" id="size" value="1189" step="1">
                    <div class="unit">Square feet (or sq meters)</div>
                </div>

                <div class="input-group">
                    <label for="totalValue">Total Property Value</label>
                    <input type="number" id="totalValue" value="1560000" step="1000">
                    <div class="unit">Currency units (USD, AED, EUR, etc.)</div>
                </div>

                <div class="input-group">
                    <label for="downPayment">Down Payment (Initial Equity)</label>
                    <input type="number" id="downPayment" value="20" step="1" min="0" max="100">
                    <div class="unit">Percentage (%) of property value</div>
                </div>

                <div class="input-group">
                    <label for="tenure">Mortgage Tenure</label>
                    <input type="number" id="tenure" value="25" step="1" min="1" max="30">
                    <div class="unit">Years (typical: 15-30 years)</div>
                </div>

                <div class="input-group">
                    <label for="discountRate">Discount Rate (Your Required Return)</label>
                    <input type="number" id="discountRate" value="4" step="0.1" min="0" max="20">
                    <div class="unit">Percentage (%) - use 4-8% typically</div>
                </div>

                <div class="input-group">
                    <label for="rentalROI">Expected Rental Yield</label>
                    <input type="number" id="rentalROI" value="6" step="0.1" min="0" max="15">
                    <div class="unit">Annual % of property value (research local market)</div>
                </div>

                <div class="input-group">
                    <label for="serviceCharges">Annual Service Charges</label>
                    <input type="number" id="serviceCharges" value="10" step="0.5" min="0">
                    <div class="unit">Per square foot/meter (maintenance, HOA fees)</div>
                </div>

                <div class="input-group">
                    <label for="potentialPricePSF">Exit Price per sq ft (Conservative)</label>
                    <input type="number" id="potentialPricePSF" value="1400" step="10" min="0">
                    <div class="unit">Expected selling price per unit area at exit</div>
                </div>

                <button class="calculate-btn" onclick="calculate()">Calculate Investment Feasibility</button>
            </div>

            <!-- Results Section -->
            <div class="card">
                <h2>Valuation Results</h2>

                <div class="results-grid">
                    <div class="metric-card success">
                        <div class="metric-label">Discounted Cash Flow (DCF)</div>
                        <div class="metric-value" id="dcf">-</div>
                        <div class="metric-subtext">PV of all future cash flows</div>
                    </div>

                    <div class="metric-card success">
                        <div class="metric-label">Net Present Value (NPV)</div>
                        <div class="metric-value" id="npv">-</div>
                        <div class="metric-subtext">DCF minus initial investment</div>
                    </div>

                    <div class="metric-card success">
                        <div class="metric-label">Internal Rate of Return (IRR)</div>
                        <div class="metric-value" id="irr">-</div>
                        <div class="metric-subtext">Annualized return rate</div>
                    </div>

                    <div class="metric-card highlight">
                        <div class="metric-label">Return on Invested Capital (ROIC)</div>
                        <div class="metric-value" id="roic">-</div>
                        <div class="metric-subtext">Total return on investment</div>
                    </div>
                </div>

                <div class="interpretation" id="interpretation">
                    <h3>
                        <span>Investment Decision:</span>
                        <span class="status-badge" id="statusBadge">-</span>
                    </h3>

                    <ul class="criteria-list" id="criteriaList">
                    </ul>

                    <div class="risk-factors">
                        <h4>‚ö†Ô∏è Key Risk Considerations</h4>
                        <ul>
                            <li>Model assumes 100% occupancy (zero vacancy)</li>
                            <li>Fixed interest rate over entire loan period</li>
                            <li>No rental escalation modeled (conservative)</li>
                            <li>Service charges assumed constant</li>
                            <li>Terminal value is an assumption - actual exit price may vary</li>
                            <li>Market conditions at exit year impact actual returns</li>
                        </ul>
                    </div>

                    <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 0.85em; color: #1565c0;">
                            <strong>‚ÑπÔ∏è This Model Uses Proper DCF Methodology:</strong><br>
                            ‚Ä¢ All future cash flows are discounted to present value using time value of money<br>
                            ‚Ä¢ Terminal value is properly discounted: FV / (1 + rate)^years<br>
                            ‚Ä¢ Works with any currency (USD, AED, EUR, GBP, etc.)<br>
                            ‚Ä¢ Based on the same principles used by institutional investors<br>
                            <br>
                            <strong>üìö Scroll up to read the educational guide</strong> for detailed explanations of each formula and concept.
                        </div>
                    </div>
                </div>

                <div class="breakdown-section">
                    <h3>Investment Breakdown</h3>
                    <div id="breakdown"></div>
                </div>

                <div class="cash-flow-viz">
                    <h3>Cash Flow Profile</h3>
                    <div class="cash-flow-bars" id="cashFlowBars"></div>
                    <div style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;" id="cashFlowLabel">
                        Year 0 (Initial Investment) ‚Üí Year 25
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Financial calculation functions
        function PMT(rate, nper, pv) {
            if (rate === 0) return -pv / nper;
            const pvif = Math.pow(1 + rate, nper);
            return rate / (pvif - 1) * -(pv * pvif);
        }

        function NPV(rate, cashFlows) {
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + rate, i);
            }
            return npv;
        }

        function NPV_Excel(rate, futureCashFlows) {
            // Excel NPV starts discounting from year 1
            let npv = 0;
            for (let i = 0; i < futureCashFlows.length; i++) {
                npv += futureCashFlows[i] / Math.pow(1 + rate, i + 1);
            }
            return npv;
        }

        function IRR(cashFlows, guess = 0.1) {
            const maxIterations = 100;
            const tolerance = 0.0001;

            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dnpv = 0;

                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + guess, j);
                    dnpv += -j * cashFlows[j] / Math.pow(1 + guess, j + 1);
                }

                const newGuess = guess - npv / dnpv;

                if (Math.abs(newGuess - guess) < tolerance) {
                    return newGuess;
                }

                guess = newGuess;
            }

            return guess;
        }

        function formatCurrency(value) {
            return value.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function formatPercent(value) {
            return value.toFixed(2) + '%';
        }

        function calculate() {
            // Get inputs
            const size = parseFloat(document.getElementById('size').value);
            const totalValue = parseFloat(document.getElementById('totalValue').value);
            const downPaymentPct = parseFloat(document.getElementById('downPayment').value) / 100;
            const tenure = parseFloat(document.getElementById('tenure').value);
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;
            const rentalROI = parseFloat(document.getElementById('rentalROI').value) / 100;
            const serviceChargePSF = parseFloat(document.getElementById('serviceCharges').value);
            const potentialPricePSF = parseFloat(document.getElementById('potentialPricePSF').value);

            // Exit year equals loan tenure
            const exitYear = tenure;

            // Calculate Terminal Value (properly discounted to present value)
            // Terminal FV = Size √ó Potential Price per sq ft
            // Terminal PV = Terminal FV / (1 + rate)^years
            const terminalValueFV = size * potentialPricePSF;
            const terminalValuePV = terminalValueFV / Math.pow(1 + discountRate, exitYear);

            // Calculations
            const pricePerSqFt = totalValue / size;
            const downPaymentAmt = totalValue * downPaymentPct;
            const landDeptFee = totalValue * 0.04;
            const agentFee = totalValue * 0.02;
            const investedCapital = downPaymentAmt + landDeptFee + agentFee;

            const loanAmount = totalValue * (1 - downPaymentPct);
            const monthlyEMI = PMT(discountRate / 12, tenure * 12, -loanAmount);
            const annualDebtService = monthlyEMI * 12;

            const annualRental = totalValue * rentalROI;
            const annualServiceCharges = serviceChargePSF * size;
            const netOperatingIncome = annualRental - annualServiceCharges;
            const netAnnualCashFlow = netOperatingIncome - annualDebtService;

            // Build cash flow array for NPV calculation (Excel formula structure)
            // Excel NPV formula: =B27+NPV(B7, C27:V27)+B28
            // Uses only 20 years of cash flows, terminal value added without discounting
            const npvYears = 20;  // Excel uses years 1-20 only
            const futureCashFlows = [];
            for (let i = 1; i <= npvYears; i++) {
                futureCashFlows.push(netAnnualCashFlow);
            }

            // DCF calculation: NPV(future cash flows) + Terminal Value PV
            // Excel v3 formula: =NPV(B7, C27:V27)+B28 (where B28 is already PV)
            const npvFuture = NPV_Excel(discountRate, futureCashFlows);
            const dcfValue = npvFuture + terminalValuePV;

            // NPV calculation: Year 0 + DCF
            // Excel v3 formula: =B27+NPV(B7, C27:V27)+B28
            const npvValue = -investedCapital + dcfValue;

            // Build cash flow array for IRR (Excel formula structure)
            // Excel IRR formula: =IRR(HSTACK(B27:V27, B28))
            // Uses years 0-20, then adds terminal value PV
            const cashFlowsIRR = [-investedCapital];
            for (let i = 1; i <= npvYears; i++) {
                cashFlowsIRR.push(netAnnualCashFlow);
            }
            // Add terminal value PV as separate cash flow
            cashFlowsIRR.push(terminalValuePV);

            const irrValue = IRR(cashFlowsIRR);

            // Build cash flow array for visualization (full tenure period)
            const cashFlows = [-investedCapital];
            for (let i = 1; i < exitYear; i++) {
                cashFlows.push(netAnnualCashFlow);
            }
            // Final year with terminal value PV
            cashFlows.push(netAnnualCashFlow + terminalValuePV);

            // Calculate ratios
            const grossYield = (annualRental / totalValue) * 100;
            const netYield = (netOperatingIncome / totalValue) * 100;
            const cashOnCashReturn = (netAnnualCashFlow / investedCapital) * 100;
            const ltv = (loanAmount / totalValue) * 100;
            const dscr = netOperatingIncome / annualDebtService;

            // ROIC = (Terminal Value PV - Invested Capital) / Invested Capital
            // Excel v3 formula: =(B28-B19)/B19 (where B28 is PV)
            const roicValue = ((terminalValuePV - investedCapital) / investedCapital) * 100;

            // Update results
            document.getElementById('dcf').textContent = formatCurrency(dcfValue);
            document.getElementById('npv').textContent = formatCurrency(npvValue);
            document.getElementById('irr').textContent = formatPercent(irrValue * 100);
            document.getElementById('roic').textContent = formatPercent(roicValue);

            // Determine investment status
            const isNPVPositive = npvValue > 0;
            const isIRRAboveHurdle = irrValue > discountRate;
            const isCashFlowPositive = netAnnualCashFlow > 0;
            const isDSCRHealthy = dscr > 1.0;

            const allCriteriaMet = isNPVPositive && isIRRAboveHurdle && isCashFlowPositive && isDSCRHealthy;
            const someCriteriaMet = isNPVPositive || isIRRAboveHurdle;

            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            if (allCriteriaMet) {
                statusBadge.textContent = '‚úì FEASIBLE';
                statusBadge.className = 'status-badge success';
            } else if (someCriteriaMet) {
                statusBadge.textContent = '‚ö† MARGINAL';
                statusBadge.className = 'status-badge warning';
            } else {
                statusBadge.textContent = '‚úó NOT FEASIBLE';
                statusBadge.className = 'status-badge danger';
            }

            // Update criteria list
            const criteriaList = document.getElementById('criteriaList');
            criteriaList.innerHTML = `
                <li>
                    <span class="icon">${isNPVPositive ? '‚úÖ' : '‚ùå'}</span>
                    <span><strong>NPV Positive:</strong> ${formatCurrency(npvValue)} ${isNPVPositive ? '(Creates value)' : '(Destroys value)'}</span>
                </li>
                <li>
                    <span class="icon">${isIRRAboveHurdle ? '‚úÖ' : '‚ùå'}</span>
                    <span><strong>IRR > Hurdle Rate:</strong> ${formatPercent(irrValue * 100)} vs ${formatPercent(discountRate * 100)} ${isIRRAboveHurdle ? '(Exceeds requirement)' : '(Below requirement)'}</span>
                </li>
                <li>
                    <span class="icon">${isCashFlowPositive ? '‚úÖ' : '‚ùå'}</span>
                    <span><strong>Positive Cash Flow:</strong> ${formatCurrency(netAnnualCashFlow)} ${isCashFlowPositive ? 'annual surplus' : 'annual deficit'}</span>
                </li>
                <li>
                    <span class="icon">${isDSCRHealthy ? '‚úÖ' : '‚ùå'}</span>
                    <span><strong>Debt Coverage Ratio:</strong> ${dscr.toFixed(2)}x ${isDSCRHealthy ? '(Sustainable)' : '(At risk)'}</span>
                </li>
            `;

            // Update breakdown
            const breakdown = document.getElementById('breakdown');
            breakdown.innerHTML = `
                <div class="breakdown-item">
                    <span>Down Payment (${(downPaymentPct * 100).toFixed(0)}%)</span>
                    <span>${formatCurrency(downPaymentAmt)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Dubai Land Dept Fee (4%)</span>
                    <span>${formatCurrency(landDeptFee)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Agent Commission (2%)</span>
                    <span>${formatCurrency(agentFee)}</span>
                </div>
                <div class="breakdown-item total">
                    <span>Total Initial Investment</span>
                    <span>${formatCurrency(investedCapital)}</span>
                </div>
                <div class="breakdown-item" style="margin-top: 15px;">
                    <span>Loan Amount (${(100 - downPaymentPct * 100).toFixed(0)}%)</span>
                    <span>${formatCurrency(loanAmount)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Monthly EMI</span>
                    <span>${formatCurrency(monthlyEMI)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Annual Rental Income</span>
                    <span>${formatCurrency(annualRental)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Gross Rental Yield</span>
                    <span>${formatPercent(grossYield)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Debt Service Coverage Ratio</span>
                    <span>${dscr.toFixed(2)}x</span>
                </div>
                <div class="breakdown-item" style="margin-top: 15px; background: #e7f5ff; border-left: 4px solid #667eea;">
                    <span>Terminal Value FV (Year ${exitYear})</span>
                    <span>${formatCurrency(terminalValueFV)}</span>
                </div>
                <div class="breakdown-item" style="background: #e7f5ff; border-left: 4px solid #667eea;">
                    <span>Terminal Value PV (Discounted)</span>
                    <span>${formatCurrency(terminalValuePV)}</span>
                </div>
                <div class="breakdown-item" style="background: #e7f5ff; border-left: 4px solid #667eea;">
                    <span>Discount Factor</span>
                    <span>${(1 / Math.pow(1 + discountRate, exitYear)).toFixed(4)}x</span>
                </div>
            `;

            // Update cash flow label
            document.getElementById('cashFlowLabel').textContent =
                `Year 0 (Initial Investment) ‚Üí Year ${exitYear} (Loan Maturity + Property Sale)`;

            // Update cash flow visualization with arrows
            const cashFlowBars = document.getElementById('cashFlowBars');
            cashFlowBars.innerHTML = '';

            cashFlows.forEach((cf, index) => {
                const item = document.createElement('div');
                item.className = 'cash-flow-item';

                const arrowContainer = document.createElement('div');
                arrowContainer.className = 'arrow-container';

                const arrow = document.createElement('div');
                arrow.className = 'arrow ' + (cf < 0 ? 'down' : 'up');
                arrow.innerHTML = cf < 0 ? '‚Üì' : '‚Üë';
                arrow.title = `${formatCurrency(cf)}`;

                const yearLabel = document.createElement('div');
                yearLabel.className = 'year-label';
                yearLabel.textContent = `Y${index}`;

                const amountLabel = document.createElement('div');
                amountLabel.className = 'amount-label';
                if (Math.abs(cf) >= 1000000) {
                    amountLabel.textContent = `${(cf/1000000).toFixed(1)}M`;
                } else if (Math.abs(cf) >= 1000) {
                    amountLabel.textContent = `${(cf/1000).toFixed(0)}K`;
                } else {
                    amountLabel.textContent = `${cf.toFixed(0)}`;
                }

                arrowContainer.appendChild(arrow);
                item.appendChild(yearLabel);
                item.appendChild(arrowContainer);
                item.appendChild(amountLabel);
                cashFlowBars.appendChild(item);
            });
        }

        // Toggle educational content
        function toggleEducation() {
            const content = document.getElementById('educationalContent');
            const btn = document.querySelector('.toggle-btn');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = 'üìö Hide Educational Content (Click to Collapse)';
            } else {
                content.classList.add('hidden');
                btn.textContent = 'üìö Learn How This Calculator Works (Click to Expand)';
            }
        }

        // Calculate on page load
        window.onload = calculate;

        // Add event listeners for real-time calculation
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculate);
        });
    </script>
</body>
</html>
